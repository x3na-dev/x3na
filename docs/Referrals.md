# Referrals Smart Contract Documentation

## Overview

Referrals is an upgradeable smart contract that manages a multi-tier referral rewards system. It tracks user registrations, calculates commission-based rewards, and enables referrers to earn a percentage of their referrals' betting activity.

## Contract Architecture

### Inheritance

```
Referrals
â”œâ”€â”€ Initializable (upgradeable pattern)
â”œâ”€â”€ AccessControlUpgradeable (role-based access)
â””â”€â”€ ReentrancyGuardUpgradeable (security)
```

### Roles

| Role                 | Description                                                               |
| -------------------- | ------------------------------------------------------------------------- |
| `DEFAULT_ADMIN_ROLE` | Full administrative access, can set custom commissions and withdraw funds |
| `OPERATOR_ROLE`      | Can register users, update turnover, and distribute rewards               |

---

## State Variables

### Mappings

| Mapping                  | Type                 | Description                                    |
| ------------------------ | -------------------- | ---------------------------------------------- |
| `registrationTimestamps` | `address => uint64`  | Unix timestamp when user registered            |
| `referrers`              | `address => address` | User's referrer address                        |
| `rewards`                | `address => uint256` | Total rewards earned by referrer (all-time)    |
| `claimedRewards`         | `address => uint256` | Total rewards already claimed                  |
| `referralsBetsAmount`    | `address => uint256` | Total turnover generated by referrals (in wei) |
| `customCommissions`      | `address => uint64`  | Custom commission rate in BPS (0 = not set)    |

---

## Events

| Event                    | Parameters               | Description                                    |
| ------------------------ | ------------------------ | ---------------------------------------------- |
| `RegisterUser`           | `user`, `referrer`       | Emitted when a user registers with a referrer  |
| `UpdateRewards`          | `user`, `amount`, `from` | Emitted when rewards are added to a referrer   |
| `ClaimRewards`           | `user`, `amount`         | Emitted when a user claims their rewards       |
| `SetCustomCommission`    | `user`, `bps`            | Emitted when admin sets a custom commission    |
| `RemoveCustomCommission` | `user`                   | Emitted when admin removes a custom commission |

---

## Referral Rank System

The contract implements a dynamic 8-tier commission system based on total turnover:

| Rank           | Turnover Range  | Commission (BPS) | Commission (%) |
| -------------- | --------------- | ---------------- | -------------- |
| **Starter**    | $0 - $999       | 2000             | 20%            |
| **Bronze**     | $1K - $4.9K     | 2500             | 25%            |
| **Silver**     | $5K - $19.9K    | 3000             | 30%            |
| **Gold**       | $20K - $49.9K   | 3500             | 35%            |
| **Platinum**   | $50K - $99.9K   | 4000             | 40%            |
| **Pro**        | $100K - $249.9K | 4500             | 45%            |
| **Ambassador** | $250K - $499.9K | 5000             | 50%            |
| **KOL**        | $500K+          | 6000             | 60%            |
| **Custom**     | Any             | Admin-defined    | Variable       |

> ğŸ’¡ **Note:** Turnover thresholds assume 1 ETH â‰ˆ $1 for simplicity. Amounts are stored in wei.

---

## Functions

### Public Functions (Users)

#### `register(address referrer)`

Register yourself with a referrer.

**Requirements:**

- User not already registered
- Valid referrer address
- Cannot refer yourself

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| `referrer` | `address` | The referrer's wallet address |

---

#### `claimRewards()`

Claim all pending referral rewards.

**Requirements:**

- Must have unclaimed rewards

**Process:**

```
claimable = rewards[user] - claimedRewards[user]
â†’ Transfer claimable amount to user
â†’ Update claimedRewards[user]
```

---

#### `getClaimableRewards(address user) â†’ uint256`

View function to check unclaimed rewards.

**Returns:** Amount of rewards available to claim (in wei)

---

#### `getUserRank(address user) â†’ (uint64 bps, string rankName)`

Get the current commission rate and rank name for a user.

**Returns:**
| Name | Type | Description |
|------|------|-------------|
| `bps` | `uint64` | Commission rate in basis points |
| `rankName` | `string` | Rank name (e.g., "Gold", "Custom") |

---

#### `getReferralStats(address user)`

Get comprehensive referral statistics for a user.

**Returns:**

```solidity
(
    address referrer,         // User's referrer
    uint256 totalRewards,     // Total earned (all-time)
    uint256 claimedAmount,    // Total claimed
    uint256 claimableAmount,  // Available to claim
    uint256 turnover,         // Total referral turnover
    uint64 currentRankBps,    // Current commission rate
    string memory rankName    // Current rank name
)
```

---

### Operator Functions

#### `registerUser(address user, address referrer)`

Register a user with a referrer (operator-only).

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| `user` | `address` | User to register |
| `referrer` | `address` | Referrer's address |

---

#### `incrementBetsAmount(address causer, uint256 amount)`

Update the turnover for a user's referrer.

**Called by:** X3NA contract when a bet is placed

**Process:**

```
1. Get causer's referrer
2. Add amount to referrer's turnover
3. Rank automatically recalculated on next query
```

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| `causer` | `address` | User who placed the bet |
| `amount` | `uint256` | Bet amount in wei |

---

#### `doRewards(address causer, uint256 amount)`

Distribute rewards to a user's referrer.

**Payable:** Must send ETH to cover the reward

**Process:**

```
1. Get causer's referrer
2. Calculate reward: amount * referrerBps / 10000
3. Require msg.value >= reward
4. Add reward to referrer's balance
5. Refund excess ETH if any
```

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| `causer` | `address` | User who generated the reward |
| `amount` | `uint256` | Base amount for reward calculation |

**Example:**

```solidity
// If referrer is Gold rank (35% = 3500 BPS)
// and amount = 1 ETH
reward = 1 ETH * 3500 / 10000 = 0.35 ETH
```

---

### Admin Functions

#### `addCustomCommission(address user, uint64 bps)`

Set a custom commission rate for a specific user.

**Requirements:**

- Valid user address
- BPS between 1 and 10000 (0.01% to 100%)

**Use Cases:**

- Special promotions
- VIP partners
- Influencer deals

---

#### `removeCustomCommission(address user)`

Remove custom commission, reverting to tier-based calculation.

**Requirements:**

- User must have a custom commission set

---

#### `hasCustomCommission(address user) â†’ bool`

Check if a user has a custom commission rate.

---

#### `fundContract()`

Payable function for admin to add ETH to the contract for reward distribution.

---

#### `adminWithdraw(address to, uint256 amount)`

Emergency withdrawal function for admin.

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| `to` | `address` | Recipient address |
| `amount` | `uint256` | Amount to withdraw (wei) |

---

## Workflow Examples

### User Registration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REGISTRATION FLOW                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. User calls register(referrerAddress)                    â”‚
â”‚     â””â”€â–º Checks: Not registered, valid referrer              â”‚
â”‚                                                             â”‚
â”‚  2. Contract stores:                                        â”‚
â”‚     â”œâ”€â–º registrationTimestamps[user] = block.timestamp      â”‚
â”‚     â””â”€â–º referrers[user] = referrer                          â”‚
â”‚                                                             â”‚
â”‚  3. Emit RegisterUser event                                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Reward Distribution Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   REWARD DISTRIBUTION                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. User places bet on X3NA contract                        â”‚
â”‚     â””â”€â–º X3NA calls incrementBetsAmount(user, betAmount)     â”‚
â”‚         â””â”€â–º Updates referrer's turnover                     â”‚
â”‚                                                             â”‚
â”‚  2. Backend/Operator distributes rewards                    â”‚
â”‚     â””â”€â–º Calls doRewards(user, rewardBase) with ETH          â”‚
â”‚         â”œâ”€â–º Calculate: reward = base * referrerBps / 10000  â”‚
â”‚         â”œâ”€â–º Add to rewards[referrer]                        â”‚
â”‚         â””â”€â–º Emit UpdateRewards                              â”‚
â”‚                                                             â”‚
â”‚  3. Referrer claims rewards                                 â”‚
â”‚     â””â”€â–º Calls claimRewards()                                â”‚
â”‚         â”œâ”€â–º Calculate claimable                             â”‚
â”‚         â”œâ”€â–º Transfer ETH                                    â”‚
â”‚         â””â”€â–º Update claimedRewards                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Rank Progression Example

```
Alice refers Bob

Bob bets $500    â†’ Alice: Starter (20%)  â†’ $100 reward
Bob bets $1,000  â†’ Alice: Bronze (25%)   â†’ $250 reward
Bob bets $5,000  â†’ Alice: Silver (30%)   â†’ $1,500 reward
                   (Total turnover: $6,500)
```

---

## Security Features

1. **ReentrancyGuard** - Protects `claimRewards`, `doRewards`, and `incrementBetsAmount`
2. **Access Control** - Role-based permissions for critical operations
3. **Safe Native Transfer** - Proper error handling for ETH transfers
4. **Registration Checks** - Prevents duplicate registration and self-referral
5. **Amount Validation** - Requires positive amounts and valid addresses

---

## Integration with X3NA

The Referrals contract is designed to work with the X3NA prediction market:

| X3NA Action               | Referrals Call          | Purpose                |
| ------------------------- | ----------------------- | ---------------------- |
| `bet()`                   | `incrementBetsAmount()` | Track turnover         |
| Round reward distribution | `doRewards()`           | Distribute commissions |
| User registration         | `registerUser()`        | Link user to referrer  |

---

## Data Queries

### Check Referral Status

```solidity
function getReferralStats(address user) external view returns (
    address referrer,
    uint256 totalRewards,
    uint256 claimedAmount,
    uint256 claimableAmount,
    uint256 turnover,
    uint64 currentRankBps,
    string memory rankName
)
```

### Get Specific Information

```solidity
getClaimableRewards(user)      // Unclaimed balance
getUserRank(user)               // Current rank & commission
hasCustomCommission(user)       // Check if custom rate
referrers[user]                 // Get referrer address
```

---

## Commission Calculation Examples

### Standard Tier (Gold - 35%)

```
User bets: $100
Referrer reward = $100 * 3500 / 10000 = $35
```

### Custom Commission (50%)

```
Admin sets: addCustomCommission(alice, 5000)
User bets: $100
Alice reward = $100 * 5000 / 10000 = $50
```

---

## Initialization

```solidity
function initialize() public initializer
```

**Setup:**

- Grants `DEFAULT_ADMIN_ROLE` to deployer
- No additional parameters required

---

## Gas Optimization Notes

- Turnover tracking is O(1) - no loops
- Rank calculation is view function (no gas cost)
- Claims are single-user operations
- No unbounded arrays or iterations

---

## Important Considerations

âš ï¸ **Turnover is Lifetime** - `referralsBetsAmount` never decreases, ensuring ranks only progress forward

ğŸ’° **Rewards Pool** - Contract must be funded via `fundContract()` or `receive()` to distribute rewards

ğŸ”’ **One-Time Registration** - Users can only register once and cannot change referrer

ğŸ“ˆ **Dynamic Ranks** - Commission rates update automatically based on accumulated turnover
